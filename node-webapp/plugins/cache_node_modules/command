cd ${PROJECT_ROOT};

# Find parent dirs for all package.json files that are not in a `node_modules`
# dir (we don't want to cache recursively).
NODE_MODULES_PARENT_DIR=`find . -name "package.json" -not -path \
  "**/node_modules/*" | xargs -I{} dirname {}`;

pushd ${PROJECT_ROOT}

for dir in ${NODE_MODULES_PARENT_DIR}; do
  pushd ${dir};

  # Make sure the cache dir exists.
  mkdir -p ${DEPLOY_CACHE_DIR}/${dir}/node_modules;
  # Unlink first to make sure we can symlink it (TODO: WTF?)
  if [ -L node_modules ]; then
    unlink node_modules
  fi
  # Symlink the cache dir into our project (at the right place).
  ln -s ${DEPLOY_CACHE_DIR}/${dir}/node_modules ./ || true;

  echo "Installing node modules in `pwd`"

  npm install;
  npm prune;

  popd;
done

popd
